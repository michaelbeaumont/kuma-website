# Data plane proxy membership

Data plane proxy membership lets us put a set of rules that are executed when a data plane proxy is joining a mesh.

Membership contains two list

* Requirements - a data plane proxy has to fulfill _at least one_ requirement to join a mesh.
* Restrictions - a data plane proxy cannot fulfill _any_ restriction to join a mesh.

Keep in mind that membership rules are enforced only on new data plane proxies.
If we put rules that existing data plane proxies violate, we need to remove them manually from the mesh. 

## Usage

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Kubernetes"
```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  dataplaneProxyMembership:
    requirements:
    - tags: # set of required tags. You can specify '*' in value to require non-empty value of tag
        kuma.io/zone: east
    restrictions:
    - tags: # set of restricted tags. You can specify '*' in value to restrict tag with any value
        kuma.io/service: backend
```
:::
::: tab "Universal"
```yaml
type: Mesh
name: default
dataplaneProxyMembership:
  requirements:
    - tags: # set of required tags. You can specify '*' in value to require non-empty value of tag
        kuma.io/zone: east
  restrictions:
    - tags: # set of restricted tags. You can specify '*' in value to restrict tag with any value
        kuma.io/service: backend
```
:::
::::

## Example use cases

### Restrict which Pods in Kubernetes namespaces can join a Mesh

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Kubernetes"
```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  dataplaneProxyMembership:
    requirements:
    - tags: 
        kuma.io/namespace: ns-1
    - tags:
        kuma.io/namespace: ns-2
```
:::
::: tab "Universal"
```yaml
type: Mesh
name: default
dataplaneProxyMembership:
  requirements:
    - tags:
        kuma.io/namespace: ns-1
    - tags:
        kuma.io/namespace: ns-2
```
:::
::::

By default, any Pod can join any mesh by changing its `kuma.io/mesh` annotation.
We can restrict that by relying on autogenerated `k8s.kuma.io/namespace` tag.
In this example, only data plane proxies from `ns-1` and `ns-2` can join a `default` mesh.
If there is another mesh without any requirements, Pods from `ns-1` and `ns-2` namespaces can also join that mesh.

### Enforce consistency of tags

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Kubernetes"
```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  dataplaneProxyMembership:
    requirements:
    - tags: 
        team: '*'
        cloud: '*'
    restrictions:
    - tags:
        legacy: '*'
```
:::
::: tab "Universal"
```yaml
type: Mesh
name: default
dataplaneProxyMembership:
  requirements:
    - tags:
        team: '*'
        cloud: '*'
  restrictions:
    - tags:
        legacy: '*'
```
:::
::::

By using membership, we can enforce consistency of tags in Kuma deployment.
With the example above, every data plane proxy must have non-empty `team` and `cloud` tags and cannot have `legacy` tag. 

### Multizone mesh segmentation

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Kubernetes"
```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  dataplaneProxyMembership:
    requirements:
    - tags: 
        kuma.io/zone: east
---
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: demo
spec:
  dataplaneProxyMembership:
    requirements:
      - tags:
          kuma.io/zone: west
```
:::
::: tab "Universal"
```yaml
type: Mesh
name: default
dataplaneProxyMembership:
  requirements:
  - tags:
      kuma.io/zone: east
---
type: Mesh
name: demo
dataplaneProxyMembership:
  requirements:
    - tags:
        kuma.io/zone: west
```
:::
::::

This way, only data plane proxies from the `east` zone can join `default` mesh and only data plane proxies from the `west` zone can join `demo` mesh. 
